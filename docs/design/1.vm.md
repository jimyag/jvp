# VM 模块

## 模块职责

虚拟机（VM）是运行在虚拟化环境中的计算实例。VM 模块负责虚拟机的完整生命周期管理，是用户交互的核心模块。

## 核心能力

### 生命周期管理

管理虚拟机从创建到销毁的整个生命周期：创建、启动、停止、重启、删除。

### 资源管理

- 计算资源：配置和调整 CPU、内存
- 存储资源：附加和分离存储卷
- 网络资源：连接虚拟网络

### 状态监控

实时查询虚拟机的运行状态和资源使用情况（CPU、内存、磁盘 IO、网络 IO）。

### 快照管理

为虚拟机创建快照、回滚到指定快照状态。

### 控制台访问

提供两种方式访问虚拟机：
- VNC Console：图形界面
- Serial Console：命令行界面

### 安全管理

管理虚拟机的访问凭证：密码重置、SSH 密钥管理。

## API 端点

### 创建虚拟机

`POST /api/create-vm`

基于模板创建一个新的虚拟机实例。创建时需要指定模板、CPU/内存配置、存储池和网络配置。虚拟机创建后处于关机状态。

关键行为：
- 使用 CoW（写时复制）机制，基于模板快速创建虚拟机磁盘
- 虚拟机名称必须全局唯一
- 验证节点是否有足够的资源（CPU、内存）
- 验证模板和存储池是否可用
- 创建失败会自动清理已创建的资源

---

### 启动虚拟机

`POST /api/start-vm`

启动处于关机状态的虚拟机。启动成功后虚拟机进入运行状态。

注意事项：
- 虚拟机必须处于关机状态
- 节点必须有足够的可用资源
- 启动失败后虚拟机保持关机状态

---

### 停止虚拟机

`POST /api/stop-vm`

优雅地关闭运行中的虚拟机。通过 ACPI 信号请求虚拟机关机，类似于按下电源按钮。

关键行为：
- 默认优雅关机，等待虚拟机正常关闭
- 支持强制关机选项（相当于断电）
- 支持超时参数，超时后自动强制关机

注意事项：
- 虚拟机必须处于运行状态
- 优雅关机需要虚拟机支持 ACPI
- 强制关机可能导致数据丢失

---

### 重启虚拟机

`POST /api/reboot-vm`

重启运行中的虚拟机。优雅重启通过 ACPI 信号实现，强制重启直接复位虚拟机。

注意事项：
- 虚拟机必须处于运行状态
- 建议使用优雅重启避免数据丢失

---

### 删除虚拟机

`POST /api/delete-vm`

删除虚拟机及其关联的系统盘。数据卷（额外附加的 volume）默认不删除。

关键行为：
- 虚拟机必须先停止才能删除
- 删除系统盘（基于模板创建的磁盘）
- 额外附加的数据卷会自动分离，但不删除
- 快照默认不删除，可选择同时删除

注意事项：
- 删除操作不可逆
- 建议删除前先创建快照

---

### 列举虚拟机

`POST /api/list-vms`

列举所有虚拟机，支持按状态、名称等条件过滤。

支持的过滤条件：
- 状态：running / shutoff / paused
- 名称：模糊匹配
- 标签：按元数据标签过滤
- 节点：指定节点上的虚拟机

---

### 查询虚拟机详情

`POST /api/describe-vm`

查询虚拟机的详细信息，包括配置、状态、资源使用、磁盘、网络等。

返回信息包括：
- 基本信息：名称、UUID、状态、创建时间
- 配置信息：CPU、内存、模板、存储池
- 磁盘信息：系统盘和数据卷列表
- 网络信息：网络接口、IP 地址
- 资源使用：CPU 使用率、内存使用率

---

### 查询虚拟机监控指标

`POST /api/describe-vm-metrics`

查询虚拟机在指定时间段内的资源使用情况，用于性能监控和分析。

监控指标：
- CPU 使用率（百分比）
- 内存使用量（MB）
- 磁盘 IO（读写速率、IOPS）
- 网络 IO（接收/发送速率、包数）

注意事项：
- 虚拟机必须处于运行状态
- 监控数据精度取决于采集间隔

---

### 查询虚拟机 XML 配置

`POST /api/describe-vm-xml`

返回虚拟机的 libvirt XML 配置文件，用于查看底层配置或调试。

使用场景：
- 调试虚拟机配置问题
- 导出虚拟机配置
- 了解底层 libvirt 配置

---

### 修改虚拟机配置

`POST /api/modify-vm-spec`

修改虚拟机的配置，包括 CPU、内存、名称等。部分配置支持热修改（虚拟机运行时修改）。

支持修改的配置：
- CPU 核心数（需要重启生效）
- 内存大小（部分支持热修改）
- 虚拟机名称

注意事项：
- CPU 和内存增加不能超过节点可用资源
- 内存热修改有限制，通常只能增加不能减少
- 名称修改需要确保新名称全局唯一

---

### 附加存储卷

`POST /api/attach-volume`

将一个存储卷附加到虚拟机，作为额外的数据盘使用。支持热插拔（虚拟机运行时附加）。

关键行为：
- 验证存储卷是否可用（未被其他虚拟机使用）
- 自动分配设备名称（vdb、vdc 等）
- 虚拟机运行时附加需要操作系统支持热插拔

注意事项：
- 同一个卷不能同时附加到多个虚拟机
- 附加后需要在虚拟机内部识别和挂载
- 热插拔需要虚拟机内核支持

---

### 分离存储卷

`POST /api/detach-volume`

从虚拟机分离存储卷。分离后存储卷变为可用状态，可以附加到其他虚拟机。

关键行为：
- 验证存储卷已附加到该虚拟机
- 支持热分离（虚拟机运行时分离）

注意事项：
- 系统盘不能分离
- 分离前需要在虚拟机内部卸载文件系统
- 强制分离可能导致数据丢失

---

### 创建快照

`POST /api/create-snapshot`

为虚拟机创建快照，保存当前的完整状态。快照可用于备份和恢复。

关键行为：
- 创建快照期间虚拟机会短暂暂停（通常小于 1 秒）
- 支持保存内存状态（可选）
- qcow2 格式使用增量快照，节省空间

注意事项：
- 快照名称在同一虚拟机内必须唯一
- 包含内存状态的快照体积更大
- 频繁创建快照会影响性能

---

### 回滚快照

`POST /api/revert-to-snapshot`

将虚拟机恢复到指定快照的状态。回滚后，快照创建之后的所有变更会丢失。

关键行为：
- 虚拟机必须处于关机状态
- 回滚后当前状态会丢失
- 回滚不会删除快照本身

注意事项：
- 回滚操作不可逆
- 建议在回滚前创建新的快照

---

### VNC Console

`POST /api/get-vnc-console`

获取虚拟机的 VNC 控制台连接信息（IP、端口、密码），用于图形界面访问。

使用场景：
- 图形界面操作系统（Windows、Desktop Linux）
- 操作系统安装
- 网络配置失败时的备用访问方式

---

### Serial Console

`POST /api/get-serial-console`

获取虚拟机的串口控制台连接信息，用于命令行访问。

使用场景：
- 服务器操作系统（Linux Server）
- 系统调试和故障排查
- 网络配置失败时的备用访问方式

注意事项：
- 需要虚拟机内部配置串口终端
- Linux 系统需要在内核参数中启用 console=ttyS0

---

### 重置密码

`POST /api/reset-vm-password`

重置虚拟机的用户密码。支持多种重置方式，根据虚拟机配置自动选择最佳方式。

重置方式：

1. qemu-guest-agent（推荐）
   - 需要虚拟机安装并运行 qemu-guest-agent
   - 可以在运行时重置
   - 最快速

2. cloud-init
   - 需要虚拟机支持 cloud-init
   - 需要重启虚拟机生效
   - 适用于云镜像

3. virt-customize
   - 需要虚拟机关机
   - 直接修改磁盘文件
   - 兼容性最好但最慢

注意事项：
- 建议使用强密码
- virt-customize 方式需要虚拟机关机
- 重置后建议立即测试新密码

---

### 重置系统

`POST /api/reset-vm-system`

重置虚拟机到初始状态，清除所有数据和配置，相当于重新安装系统。

关键行为：
- 删除现有系统盘
- 基于原始模板重新创建系统盘
- 保留虚拟机配置（CPU、内存等）
- 附加的数据卷不受影响

注意事项：
- 虚拟机必须处于关机状态
- 系统盘数据会全部丢失
- 建议在重置前创建快照

---

### 重置密钥

`POST /api/reset-vm-keypair`

重置虚拟机的 SSH 密钥对，替换 authorized_keys 文件。

关键行为：
- 使用 cloud-init 或 qemu-guest-agent 注入新密钥
- 替换指定用户的 SSH 密钥

注意事项：
- 需要虚拟机支持 cloud-init 或安装 qemu-guest-agent
- 仅支持 Linux 系统
