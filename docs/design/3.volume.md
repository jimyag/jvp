# Volume 模块

## 模块职责

存储卷（Volume）是存储在 Storage Pool 中的虚拟磁盘。Volume 模块负责存储卷的生命周期管理和操作。

## 核心能力

### 卷的创建

支持多种方式创建存储卷：
- 创建空白卷
- 从模板创建（CoW 或完整克隆）
- 从快照创建（恢复数据）

### 卷的管理

管理存储卷的生命周期：创建、删除、列举、查询。

### 卷的操作

支持对存储卷的各种操作：
- 扩容：增加卷的大小
- 克隆：创建卷的完整副本
- 压缩：回收未使用空间（qcow2）

## 核心说明

- Volume 存储在 Storage Pool 中
- Volume 可以从 Template 创建（快速克隆或完整克隆）
- Volume 可以从 Snapshot 创建（恢复数据）
- Volume 的附加/分离操作在 VM 模块中完成
- Volume 支持在线扩容（虚拟机运行时扩容）

### 存储格式

Volume 支持两种存储格式：

1. qcow2（推荐）
   - QEMU 的 Copy-on-Write 格式
   - 支持快照、压缩、加密
   - 支持动态分配空间
   - 支持 backing file（写时复制）

2. raw
   - 原始磁盘格式
   - 性能最好（无额外开销）
   - 不支持高级特性（快照、压缩）
   - 预分配全部空间

## API 端点

### 创建存储卷

`POST /api/create-volume`

在指定的存储池中创建一个新的存储卷。支持多种创建方式。

创建方式：

1. 创建空白卷
   - 指定大小和格式
   - 用于创建数据盘

2. 从模板创建
   - backing file 方式：快速，使用 CoW 机制
   - 完整克隆方式：独立，不依赖模板

3. 从快照创建
   - 恢复快照数据到新卷
   - 用于数据恢复或测试

关键行为：
- 验证存储池是否存在且处于激活状态
- 检查存储池是否有足够空间
- qcow2 格式支持动态分配，raw 格式需要预分配全部空间
- 从模板创建时默认使用 backing file 方式

注意事项：
- 卷名称在同一存储池内必须唯一
- raw 格式创建速度较慢（需要写入全部空间）
- backing file 方式创建快速但依赖模板

---

### 删除存储卷

`POST /api/delete-volume`

删除一个存储卷。删除操作会永久删除卷数据。

关键行为：
- 验证存储卷是否存在
- 检查卷是否被虚拟机使用
- 删除卷文件

注意事项：
- 卷必须处于未附加状态
- 删除操作不可逆
- 建议删除前先创建快照或备份

---

### 列举存储卷

`POST /api/list-volumes`

列举存储卷，支持按存储池、状态等条件过滤。

支持的过滤条件：
- 存储池：指定存储池中的卷
- 使用状态：attached（已附加）/ available（可用）
- 格式：qcow2 / raw
- 名称：模糊匹配

---

### 查询存储卷详情

`POST /api/describe-volume`

查询存储卷的详细信息。

返回信息包括：
- 基本信息：名称、UUID、路径
- 格式信息：格式类型（qcow2/raw）
- 容量信息：分配大小、实际使用大小
- 所属存储池
- 附加状态：是否附加、附加到哪个虚拟机
- backing file 信息（如果有）

---

### 扩容存储卷

`POST /api/resize-volume`

增加存储卷的大小。支持在线扩容（虚拟机运行时扩容）。

关键行为：
- 验证存储卷是否存在
- 检查存储池是否有足够空间
- 只能增加大小，不能减少
- 支持在线扩容（虚拟机运行时）

注意事项：
- 扩容后需要在虚拟机内部扩展文件系统
- 扩容操作不可逆
- raw 格式扩容需要预分配额外空间
- qcow2 格式支持动态扩容

使用场景：
- 虚拟机磁盘空间不足
- 需要增加数据盘容量

---

### 克隆存储卷

`POST /api/clone-volume`

创建存储卷的完整副本。克隆的卷与原卷完全独立。

关键行为：
- 创建原卷的完整副本
- 新卷独立于原卷，不共享数据
- 克隆过程可能较慢（取决于卷大小）

注意事项：
- 克隆期间建议原卷不要被修改
- 需要足够的存储空间
- 克隆卷可以在不同存储池中

使用场景：
- 创建虚拟机的完整备份
- 创建测试环境
- 数据迁移

---

### 压缩存储卷

`POST /api/compress-volume`

回收 qcow2 格式存储卷中未使用的空间。仅支持 qcow2 格式。

关键行为：
- 扫描卷中的未使用空间
- 回收未使用的磁盘空间
- 减少卷的实际占用

注意事项：
- 仅支持 qcow2 格式
- 卷必须处于未附加状态
- 压缩过程可能较慢
- 建议定期执行以节省空间

使用场景：
- 虚拟机删除大量文件后回收空间
- 存储空间紧张时优化使用率
