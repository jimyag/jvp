# Network 模块

## 模块职责

网络（Network）为虚拟机提供网络连接。Network 模块负责虚拟网络的创建、配置和管理。

## 核心能力

### 多种网络类型支持

支持多种网络模式，满足不同场景需求：
- NAT：网络地址转换，虚拟机可访问外网
- Bridge：桥接网络，虚拟机与宿主机同网段
- Isolated：隔离网络，仅虚拟机间互通
- SR-IOV：硬件级高性能网络

### 网络管理

管理虚拟网络的生命周期：创建、删除、启动、停止、查询。

### IP 地址管理

管理网络的 IP 地址分配：DHCP 配置、静态 IP 分配。

### 防火墙管理

配置网络的防火墙规则和端口转发（可选功能）。

## 核心说明

- Network 定义虚拟机的网络环境
- 一个虚拟机可以连接多个网络
- Network 底层使用 libvirt 的网络管理功能

### 网络类型详解

1. NAT（网络地址转换）
   - 特点：
     - 虚拟机可以访问外网
     - 外网无法直接访问虚拟机
     - 虚拟机使用内网 IP
     - 宿主机作为网关
   - 适用场景：开发、测试环境
   - 典型配置：192.168.122.0/24

2. Bridge（桥接网络）
   - 特点：
     - 虚拟机与宿主机在同一网段
     - 虚拟机获得外网 IP（通过 DHCP 或静态配置）
     - 外网可以直接访问虚拟机
   - 适用场景：生产环境、需要外网访问的服务
   - 要求：需要物理网卡支持

3. Isolated（隔离网络）
   - 特点：
     - 虚拟机间可以互通
     - 虚拟机无法访问外网
     - 外网无法访问虚拟机
   - 适用场景：内部服务、安全隔离
   - 典型配置：私有内网，如 10.0.0.0/24

4. SR-IOV（单根 I/O 虚拟化）
   - 特点：
     - 硬件级虚拟化
     - 极高性能（接近物理网卡）
     - 绕过虚拟交换机
     - 每个虚拟机独占一个虚拟功能（VF）
   - 适用场景：高性能计算、网络密集型应用
   - 要求：硬件和驱动支持 SR-IOV

## API 端点

### 创建网络

`POST /api/create-network`

创建一个新的虚拟网络。

关键行为：
- 验证网络名称唯一性
- 根据网络类型配置不同参数
- NAT 类型会自动配置 iptables 规则
- Bridge 类型需要关联物理网卡
- 创建成功后网络自动启动

配置说明：
- 网络名称：必须唯一
- 网络类型：nat / bridge / isolated / sriov
- 网段（CIDR）：如 192.168.100.0/24
- 网关：通常是网段的第一个 IP
- DHCP 范围：如 192.168.100.100 - 192.168.100.200

注意事项：
- Bridge 类型需要物理网卡支持
- SR-IOV 需要硬件支持和正确配置
- 网段不能与现有网络冲突

---

### 删除网络

`POST /api/delete-network`

删除一个虚拟网络。

关键行为：
- 验证网络是否存在
- 检查是否有虚拟机连接到该网络
- 停止网络
- 删除网络配置和规则

注意事项：
- 有虚拟机连接时无法删除
- 需要先断开所有虚拟机
- 删除操作不可逆

---

### 列举网络

`POST /api/list-networks`

列举所有网络，支持按类型、状态等条件过滤。

支持的过滤条件：
- 类型：nat / bridge / isolated / sriov
- 状态：active（激活）/ inactive（未激活）
- 名称：模糊匹配

---

### 查询网络详情

`POST /api/describe-network`

查询网络的详细信息。

返回信息包括：
- 基本信息：名称、UUID、类型
- 网络配置：网段、网关、DHCP 范围
- 状态信息：是否激活、是否自动启动
- 连接统计：连接的虚拟机数量、已分配 IP 数量
- Bridge 信息：关联的物理网卡（如果是 bridge 类型）

---

### 启动网络

`POST /api/start-network`

启动一个处于未激活状态的网络。

关键行为：
- 验证网络是否存在
- 启动网络服务（dnsmasq 等）
- 配置防火墙规则
- 虚拟机可以连接到该网络

注意事项：
- 网络配置错误时启动可能失败
- Bridge 类型需要物理网卡可用

---

### 停止网络

`POST /api/stop-network`

停止一个处于激活状态的网络。

关键行为：
- 验证网络是否存在
- 检查是否有虚拟机正在使用
- 停止网络服务
- 清理防火墙规则

注意事项：
- 有虚拟机使用时无法停止
- 需要先断开或停止使用该网络的虚拟机

---

### 配置 DHCP

`POST /api/configure-network-dhcp`

配置网络的 DHCP 地址池。

关键行为：
- 设置 DHCP 地址范围
- 配置租期时间
- 更新 dnsmasq 配置
- 重启 DHCP 服务

配置参数：
- 起始 IP：地址池的起始地址
- 结束 IP：地址池的结束地址
- 租期：IP 地址的租用时间（秒）

注意事项：
- 地址范围必须在网段内
- 不要包含网关 IP
- 修改配置后需要重启网络

---

### 分配静态 IP

`POST /api/assign-static-ip`

为虚拟机分配固定的 IP 地址（基于 MAC 地址绑定）。

关键行为：
- 绑定 MAC 地址和 IP 地址
- 更新 DHCP 配置
- 虚拟机重启后仍然获得相同 IP

配置参数：
- 虚拟机 MAC 地址
- 分配的 IP 地址
- 主机名（可选）

注意事项：
- IP 地址必须在网段内
- 建议 IP 不在 DHCP 地址池范围内
- 虚拟机需要重启或重新获取 IP

---

### 查询已分配 IP

`POST /api/list-network-ips`

列出网络中所有已分配的 IP 地址和对应的虚拟机。

返回信息包括：
- IP 地址
- MAC 地址
- 虚拟机名称
- 租期信息（DHCP）
- 是否为静态分配

使用场景：
- 查看网络使用情况
- 排查 IP 冲突
- 管理 IP 分配

---

### 配置防火墙规则

`POST /api/configure-network-firewall`

配置网络的防火墙规则。可选功能，基于 iptables/nftables。

规则类型：
- 入站规则：控制进入虚拟机的流量
- 出站规则：控制虚拟机发出的流量

配置参数：
- 协议：tcp / udp / icmp
- 源地址：允许的源 IP 或网段
- 目标端口：允许的端口或端口范围
- 动作：accept / drop / reject

---

### 配置端口转发

`POST /api/configure-network-port-forward`

配置端口转发，将宿主机端口转发到虚拟机。仅支持 NAT 网络。

关键行为：
- 配置 iptables DNAT 规则
- 将宿主机的指定端口流量转发到虚拟机
- 支持 TCP 和 UDP 协议

配置参数：
- 宿主机端口：监听的端口
- 虚拟机 IP：目标虚拟机 IP
- 虚拟机端口：目标端口
- 协议：tcp / udp

使用场景：
- 从外网访问 NAT 网络中的虚拟机
- 暴露虚拟机服务（如 SSH、HTTP）

注意事项：
- 仅支持 NAT 类型网络
- 宿主机端口不能冲突
- 需要确保宿主机防火墙允许该端口
