# Snapshot 模块

## 模块职责

快照（Snapshot）是虚拟机某一时刻的完整状态。Snapshot 模块负责快照的管理和使用，包括查询、删除、回滚、导出等操作。

## 核心能力

### 快照管理

管理虚拟机快照的生命周期：列举、查询、删除。

### 快照使用

使用快照进行各种操作：
- 回滚虚拟机到快照状态
- 从快照创建新虚拟机
- 将快照导出为模板

## 核心说明

- Snapshot 的创建在 VM 模块中完成（用户为虚拟机创建快照）
- Snapshot 模块负责快照的管理和使用（查询、删除、回滚、导出）
- 快照包含虚拟机的磁盘数据，可选包含内存状态
- 快照支持增量存储（基于 qcow2 的 internal snapshot）

### 快照类型

快照根据实现方式分为两种类型：

1. Internal Snapshot（内部快照）
   - 存储在 qcow2 文件内部
   - 快照数据与磁盘文件在一起
   - 创建和回滚速度快
   - 仅支持 qcow2 格式
   - 增量存储，节省空间

2. External Snapshot（外部快照）
   - 创建新的 backing file 链
   - 快照作为独立文件存储
   - 支持所有磁盘格式
   - 更灵活但管理复杂
   - 每个快照是独立文件

## API 端点

### 列举快照

`POST /api/list-snapshots`

列举快照，支持按虚拟机、时间等条件过滤。

支持的过滤条件：
- 虚拟机 ID：列举指定虚拟机的所有快照
- 创建时间：按时间范围过滤
- 快照名称：模糊匹配
- 快照类型：internal / external

---

### 查询快照详情

`POST /api/describe-snapshot`

查询快照的详细信息。

返回信息包括：
- 基本信息：名称、UUID、创建时间
- 快照大小：占用的存储空间
- 快照类型：internal / external
- 父快照：快照链中的父快照
- 关联虚拟机：快照属于哪个虚拟机
- 内存状态：是否包含内存快照
- 虚拟机状态：创建快照时的虚拟机状态

---

### 删除快照

`POST /api/delete-snapshot`

删除一个快照。删除快照但保留虚拟机。

关键行为：
- 验证快照是否存在
- Internal snapshot 会合并到父快照或基础镜像
- External snapshot 会合并 backing file 链
- 自动处理快照链的重组

注意事项：
- 删除操作不可逆
- 删除过程中会暂时增加磁盘 IO
- 建议在虚拟机关机时删除快照
- 快照链较长时删除可能较慢

使用场景：
- 清理不再需要的快照
- 减少存储空间占用
- 简化快照链

---

### 从快照创建虚拟机

`POST /api/create-vm-from-snapshot`

基于快照克隆一个新的虚拟机。新虚拟机独立于原虚拟机。

关键行为：
- 基于快照创建新的磁盘文件
- 新虚拟机与原虚拟机配置相同
- 磁盘数据来自快照
- 可以修改新虚拟机的配置（CPU、内存等）

注意事项：
- 需要指定新虚拟机名称（必须唯一）
- 克隆过程可能较慢（取决于快照大小）
- 新虚拟机独立，修改不影响原虚拟机

使用场景：
- 基于生产环境创建测试环境
- 快速部署多个相同配置的虚拟机
- 数据恢复到新虚拟机

---

### 导出快照为模板

`POST /api/export-snapshot-to-template`

将快照导出为可复用的模板。

关键行为：
- 将快照数据导出为独立的模板文件
- 模板存储在 storage pool 的 _templates_ 目录
- 模板设置为只读
- 可以为模板添加元数据（操作系统、版本等）

注意事项：
- 导出过程可能较慢（取决于快照大小）
- 需要足够的存储空间
- 模板创建后与原快照独立

使用场景：
- 将自定义环境转换为可复用模板
- 标准化虚拟机部署
- 创建包含特定软件的镜像
