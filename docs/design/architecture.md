# 模块设计

## vm (虚拟机管理)

**职责**：虚拟机的完整生命周期管理

### 核心功能

#### 生命周期管理

1. 创建实例
   1. 指定 template
   2. cpu/mem
   3. storage pool
   4. 网络配置
2. 启动实例
3. 停止实例
4. 重启实例
5. 删除实例（终止实例）

#### 查询与监控

1. 列举查询实例（支持过滤：状态、标签等）
2. 查询实例详情
3. 查询实例的 XML 配置
4. 查询实例的监控指标（CPU/内存/磁盘/网络 IO）

#### 配置管理

1. 修改实例配置
    - CPU 核心数
    - 内存大小
    - 实例名称

#### 存储管理

1. 附加 volume 到实例
2. 从实例分离 volume

#### 快照管理

1. 创建快照（为当前实例创建快照）

#### 安全管理

1. 重置实例密码
    - 支持多种策略：qemu-guest-agent / cloud-init / virt-customize

#### 控制台访问

1. 连接 VNC console（图形界面控制台）
2. 连接 Serial console（命令行控制台）

### 依赖关系

- 依赖 **volume** 模块（附加/分离卷）
- 依赖 **template** 模块（创建实例时选择模板）
- 依赖 **network** 模块（网络连接）
- 依赖 **snapshot** 模块（快照管理）

## snapshot (虚拟机快照管理)

**职责**：虚拟机的快照的管理和使用

### 核心功能

1. 列举查询快照
   - 按实例 ID 过滤
   - 按创建时间排序
2. 查询快照详情
   - 快照大小
   - 创建时间
   - 父快照关系
   - 关联的实例
3. 删除快照
4. 回滚快照（将实例恢复到指定快照状态）
5. 从快照创建实例（基于快照克隆新实例）
6. 从快照导出为模板

### 说明

- 快照的**创建**在 **vm** 模块中（vm 第 13 项）
- vm 模块负责快照的**管理和使用**

### 依赖关系

- 依赖 **vm** 模块（关联实例）
- 被 **template** 模块依赖（导出为模板）

## storage pool (存储池管理)

**职责**：底层存储池的管理

### 支持的存储类型

- **dir**：本地目录存储
- **fs**：文件系统挂载点
- **lvm**：Linux 逻辑卷管理
- **zfs**：ZFS 存储池
- **rbd**：Ceph RBD 块设备

### 核心功能

1. 创建存储池
   - 指定存储类型（dir/fs/lvm/zfs/rbd）
   - 指定存储路径或设备
   - 配置容量和参数
2. 删除存储池
3. 列举查询存储池
   - 按类型过滤
   - 按状态过滤（active/inactive）
4. 查询存储池信息
   - 类型
   - 总容量
   - 已用容量
   - 可用容量
   - 状态
5. 启动存储池
6. 停止存储池
7. 刷新存储池（重新扫描池内的卷）

### 说明

- storage pool 只管理**池本身**，不直接管理池内的 vm/volume
- vm/volume 的管理由 **vm** 模块负责

### 依赖关系

- 被 **vm** 模块依赖（vm/volume 需要存储在池中）

## volume (卷管理)

**职责**：存储池内的 volume 管理

### 核心功能

#### 卷的创建

1. 在指定存储池中创建卷
   - 指定大小
   - 指定格式（qcow2/raw）
   - 指定 template
   - 指定 snapshot

#### 卷的管理

1. 删除卷
2. 列举查询卷
   - 按存储池过滤
   - 按使用状态过滤（attached/available）
3. 查询卷详情
   - 大小
   - 格式
   - 所属存储池
   - 使用率
   - 附加状态

#### 卷的操作

1. 扩容卷（增加卷大小）
2. 克隆卷（复制卷）
3. 压缩卷（可选，针对 qcow2 格式）

### 说明

- volume 的**附加/分离**操作在 **vm** 模块中（vm 第 8-9 项）
- **template** 本质上是 volume 的一种特殊形态（只读），存储在 storage pool 的 `/var/lib/jvp/images/_templates_/` 目录下

### 依赖关系
- 依赖 **storage pool** 模块（卷存储在池中）
- 依赖 **template** 模块（从模板创建卷）
- 依赖 **snapshot** 模块（从快照创建卷）

## template (模板管理)

**职责**：虚拟机的模板的管理

### 模板的本质

Template 是存储在 **storage pool** 中的特殊 volume：
- **特性**：只读、可被多个实例使用（作为 backing file）
- **标识**：通过路径前缀 `_templates_/` 或元数据标记
- **存储位置**：`/var/lib/jvp/images/_templates_/` (在 storage pool 中)

### 模板类型

1. **Cloud Image Template**
   - 官方云镜像（Ubuntu、Debian、Alpine 等）
   - 预装 cloud-init
   - 支持自动配置

2. **Snapshot Template**
   - 基于用户快照创建
   - 包含自定义配置和软件
   - 可复用的自定义环境

### 核心功能

#### 模板注册
1. 注册模板
   - 从 URL 下载官方云镜像
   - 从本地文件导入
   - 从快照导出为模板

#### 模板管理
2. 列举查询模板
   - 按类型过滤（cloud/snapshot）
   - 按操作系统过滤
3. 查询模板详情
   - 模板类型
   - 大小
   - 操作系统信息
   - 创建时间
4. 删除模板
5. 更新模板（可选，用于更新官方镜像）

#### 模板使用
6. 基于模板创建实例（快速克隆）
   - 使用 backing file 机制
   - 写时复制（Copy-on-Write）
7. 从模板创建卷（完整克隆）

### 依赖关系
- 依赖 **storage pool** 模块（模板存储在池中）
- 依赖 **snapshot** 模块（从快照创建模板）
- 被 **instance** 模块依赖（创建实例时选择模板）
- 被 **volume** 模块依赖（从模板创建卷）

---

## network (网络管理)

**职责**：虚拟网络的管理

### 支持的网络类型

- **NAT**：网络地址转换，实例可访问外网
- **Bridge**：桥接网络，实例与宿主机在同一网段
- **Isolated**：隔离网络，仅实例间互通
- **SR-IOV**：单根 I/O 虚拟化（高性能网络）

### 核心功能

#### 网络管理
1. 创建网络
   - 指定网络类型
   - 配置网段（CIDR）
   - 配置网关
2. 删除网络
3. 列举查询网络
   - 按类型过滤
   - 按状态过滤
4. 查询网络详情
   - 网络类型
   - 网段信息
   - 连接的实例数量
   - DHCP 配置
5. 启动网络
6. 停止网络

#### IP 地址管理
7. 配置 DHCP 地址池
   - 起始 IP
   - 结束 IP
   - 租期
8. 静态 IP 分配（可选）
9. 查询已分配的 IP 地址

#### 防火墙管理（可选）
10. 配置防火墙规则
11. 配置端口转发

### 依赖关系
- 被 **instance** 模块依赖（实例网络连接）
- 依赖 **node** 模块（使用节点的物理网络接口）

---

## node (节点管理)

**职责**：物理节点的管理和集群扩展

### 核心功能

#### 节点管理
1. 添加节点
   - 连接到远程 libvirt daemon
   - 验证节点可用性
   - 加入集群
2. 删除节点
   - 迁移运行中的实例（可选）
   - 从集群移除
3. 列举查询节点
   - 按状态过滤（online/offline/maintenance）
   - 按角色过滤（compute/storage）
4. 查询节点详情
5. 启用节点（恢复调度）
6. 禁用节点（维护模式，停止调度新实例）

#### 节点信息查询

##### summary (概要信息)
- CPU 信息
  - 核心数
  - 线程数
  - 型号
  - 频率
- 内存信息
  - 总内存
  - 可用内存
  - 已用内存
- NUMA 信息
- HugePages 配置
- 虚拟化标志（VT-x/AMD-V、EPT、IOMMU）

##### pci (PCI 设备)
- GPU（显卡）
- 网卡（Network Controllers）
- NVMe 控制器
- 其他 PCI 设备
- 支持 PCI 直通的设备列表

##### usb (USB 设备)
- USB 设备列表
- USB 控制器信息

##### net (网络接口)
- 物理网卡（NICs）
- 网桥（Bridges）
- 绑定接口（Bonds）
- SR-IOV 物理功能（PF）
- SR-IOV 虚拟功能（VF）
- 接口状态和流量统计

##### disks (物理磁盘)
- 物理磁盘列表
- NVMe 设备
- SATA 设备
- SMART 健康信息
- 磁盘容量和使用率

#### 节点操作（可选）

7. 重启节点
8. 关闭节点
9. 查询节点系统日志

### 说明
- node 模块用于**多节点集群**部署
- 单机部署时，默认只有一个本地节点
- 节点操作（重启/关闭）需要严格的权限控制

### 依赖关系
- 被 **instance** 模块依赖（实例调度到节点）
- 被 **storage pool** 模块依赖（存储池可能分布在不同节点）
- 被 **network** 模块依赖（使用节点的物理网络）

---

# 模块依赖关系图

```
┌──────────────────────────────────────────────────┐
│                   instance                       │
│  (核心模块，协调其他模块完成实例管理)              │
└─┬──────┬────────┬──────────┬────────┬───────────┘
  │      │        │          │        │
  ▼      ▼        ▼          ▼        ▼
┌───┐ ┌───────┐┌────────┐┌────────┐┌────────┐
│vol││template││snapshot││network ││  node  │
└─┬─┘ └───┬───┘└───┬────┘└────────┘└────────┘
  │       │        │
  │       │        │
  ▼       ▼        ▼
┌──────────────────────┐
│    storage pool      │
│  (底层存储资源池)     │
└──────────────────────┘
```

### 依赖说明

- **instance** 是核心模块，依赖所有其他模块
- **volume、template、snapshot** 都依赖 **storage pool**
- **template** 可以从 **snapshot** 创建
- **volume** 可以从 **template** 或 **snapshot** 创建
- **node** 为所有模块提供底层硬件资源

---

# 设计原则

## 1. 单一职责原则
- 每个模块只负责一个清晰的业务领域
- storage pool 只管理池，volume 管理卷
- instance 创建快照，snapshot 管理快照

## 2. 职责归属原则
- 从**使用者视角**归属功能：
  - volume 的附加/分离归属 instance（用户操作实例时附加卷）
  - 快照的创建归属 instance（用户为实例创建快照）
  - 快照的管理归属 snapshot（查询、删除、回滚、克隆）

## 3. 层次清晰原则
- 明确资源层次：
  - storage pool（容器层）→ volume（资源层）→ instance（使用层）
  - node（物理层）→ storage pool（存储层）→ instance（计算层）

## 4. 依赖最小化原则
- 模块间通过清晰的接口交互
- 避免循环依赖
- 底层模块不依赖上层模块

---

# 实现建议

## API 设计风格

采用 RESTful API 设计：

```
/api/instances              # 实例管理
/api/snapshots              # 快照管理
/api/storage-pools          # 存储池管理
/api/volumes                # 卷管理
/api/templates              # 模板管理
/api/networks               # 网络管理
/api/nodes                  # 节点管理
```

## 数据存储策略

### 方案 A：纯 Libvirt Metadata（简单）
- 所有状态存储在 libvirt XML
- 适用于单机、小规模部署

### 方案 B：Libvirt + 轻量级数据库（推荐）
- libvirt XML：存储实际配置
- SQLite/PostgreSQL：存储索引、关系、元数据
- 适用于单机或多节点部署

## 扩展性考虑

### 计划中的功能
- 实例迁移（在节点间迁移实例）
- 高可用（HA）
- 资源调度（自动选择最优节点）
- 监控告警
- 日志审计

---

# 总结

本架构设计遵循以下核心思想：

1. **以实例为中心**：instance 是用户交互的主要入口
2. **存储层次清晰**：pool → volume → instance 三层结构
3. **职责单一明确**：每个模块只做一件事
4. **支持集群扩展**：通过 node 模块支持多节点部署
5. **灵活可扩展**：模块间低耦合，易于扩展新功能
