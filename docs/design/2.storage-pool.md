# Storage Pool 模块

## 模块职责

存储池（Storage Pool）是底层存储资源的容器，用于存储虚拟机磁盘、模板、快照等。Storage Pool 模块负责存储池的生命周期管理。

## 核心能力

### 多种存储类型支持

支持多种存储后端，满足不同场景的需求：

- dir: 本地目录存储，使用文件系统目录存储磁盘镜像
- fs: 文件系统挂载点，支持挂载外部文件系统
- lvm: Linux 逻辑卷管理，支持快照和精简配置
- zfs: ZFS 存储池，提供压缩、去重、数据完整性保护
- rbd: Ceph RBD 块设备，分布式存储方案

### 容量管理

监控和管理存储池的容量使用情况，包括总容量、已用容量、可用容量。

### 生命周期管理

管理存储池的创建、删除、启动、停止、刷新等操作。

## 核心说明

- Storage Pool 只管理池本身，不直接管理池内的具体资源
- 池内的虚拟机磁盘、Volume、Template 由对应的模块管理
- 一个 Storage Pool 可以包含多个 Volume 和 Template
- 删除 Storage Pool 前需要确保池内没有被使用的资源

## API 端点

### 创建存储池

`POST /api/create-storage-pool`

创建一个新的存储池。根据存储类型不同，需要提供不同的配置参数。

关键行为：
- 验证存储池名称唯一性
- 根据存储类型验证配置参数
- dir 类型会自动创建目录
- lvm/zfs/rbd 类型需要验证底层资源可用性
- 创建成功后存储池处于激活状态

存储类型说明：

1. dir（目录存储）
   - 最简单常用的类型
   - 适用于开发和小规模部署
   - 磁盘镜像以文件形式存储

2. fs（文件系统）
   - 支持挂载外部文件系统
   - 适用于独立磁盘或网络存储
   - 支持 ext4、xfs 等文件系统

3. lvm（逻辑卷管理）
   - 性能较好，支持快照
   - 支持精简配置（thin provisioning）
   - 需要预先配置 LVM 卷组

4. zfs（ZFS 存储）
   - 高级特性：压缩、去重、快照
   - 数据完整性校验和自动修复
   - 需要 ZFS 内核模块支持

5. rbd（Ceph RBD）
   - 分布式块存储
   - 支持集群部署和高可用
   - 需要 Ceph 集群

---

### 删除存储池

`POST /api/delete-storage-pool`

删除一个存储池。删除操作会移除存储池配置，但默认不删除底层存储内容。

关键行为：
- 验证存储池是否存在
- 检查池内是否有正在使用的资源
- 需要先停止存储池
- 可选择是否删除底层存储内容

注意事项：
- 池内有虚拟机磁盘在使用时无法删除
- 建议删除前先迁移或删除池内资源
- 删除底层存储内容的操作不可逆

---

### 列举存储池

`POST /api/list-storage-pools`

列举所有存储池，支持按类型、状态等条件过滤。

支持的过滤条件：
- 类型：dir / fs / lvm / zfs / rbd
- 状态：active（激活）/ inactive（未激活）
- 节点：指定节点上的存储池

---

### 查询存储池详情

`POST /api/describe-storage-pool`

查询存储池的详细信息，包括类型、容量、状态等。

返回信息包括：
- 基本信息：名称、UUID、类型
- 容量信息：总容量、已用容量、可用容量
- 状态信息：是否激活、是否持久化
- 配置信息：存储路径或设备
- 资源统计：包含的 Volume 数量

---

### 启动存储池

`POST /api/start-storage-pool`

激活一个处于未激活状态的存储池。启动后存储池可以被使用。

关键行为：
- 验证存储池是否存在
- 检查底层存储资源是否可用
- fs 类型需要挂载文件系统
- lvm 类型需要激活卷组
- 启动成功后池内资源可以被访问

注意事项：
- 底层存储资源不可用时启动会失败
- 某些类型（如 nfs）可能需要网络可达

---

### 停止存储池

`POST /api/stop-storage-pool`

停用一个处于激活状态的存储池。停止后存储池内的资源无法被访问。

关键行为：
- 验证存储池是否存在
- 检查是否有资源正在使用
- fs 类型会卸载文件系统
- lvm 类型会停用卷组

注意事项：
- 池内有虚拟机磁盘正在使用时无法停止
- 需要先停止使用池内资源的虚拟机

---

### 刷新存储池

`POST /api/refresh-storage-pool`

重新扫描存储池，更新池内的卷信息。用于同步外部变更。

关键行为：
- 扫描池内的所有卷文件
- 更新卷的元数据（大小、格式等）
- 发现新添加的卷
- 移除已删除的卷

使用场景：
- 手动在存储池目录添加或删除了文件
- 外部工具修改了卷
- 存储池状态不一致时
