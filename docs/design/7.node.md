# Node 模块

## 模块职责

节点（Node）代表运行 libvirtd 的物理主机。Node 模块负责节点的管理和硬件信息查询，支持多节点集群部署。

## 核心能力

### 节点管理

管理节点的生命周期：添加、删除、启用、禁用。

### 硬件信息查询

查询节点的详细硬件信息：
- CPU、内存、NUMA 配置
- PCI 设备（GPU、网卡、NVMe）
- USB 设备
- 网络接口
- 物理磁盘

### 节点操作

控制节点的运行状态：重启、关闭、查询日志。

## 核心说明

- Node 代表一个物理主机，运行 libvirtd 服务
- 单机部署时，默认只有一个本地节点
- 多节点部署时，通过 libvirt URI 连接远程节点（如 qemu+ssh://user@host/system）
- Node 提供底层硬件资源：CPU、内存、存储、网络
- 节点操作（重启/关闭）需要严格的权限控制

## API 端点

### 添加节点

`POST /api/add-node`

将一个远程节点添加到集群。

关键行为：
- 连接到远程 libvirt daemon（通过 URI）
- 验证节点可用性和连通性
- 查询节点硬件信息
- 将节点加入集群管理

配置参数：
- 节点名称：集群内唯一标识
- 节点 URI：libvirt 连接地址（如 qemu+ssh://user@192.168.1.100/system）
- 节点类型：compute（计算节点）/ storage（存储节点）/ hybrid（混合）
- 认证信息：SSH 密钥或密码

注意事项：
- 需要确保 SSH 连接可用
- 远程节点必须安装并运行 libvirtd
- 建议使用 SSH 密钥认证

---

### 删除节点

`POST /api/delete-node`

从集群中移除一个节点。

关键行为：
- 验证节点是否存在
- 检查节点上是否有运行中的虚拟机
- 可选：迁移虚拟机到其他节点
- 断开连接并从集群移除

注意事项：
- 节点上有虚拟机时需要先迁移或停止
- 删除操作不会影响节点本身，只是移除管理
- 建议在删除前备份节点配置

---

### 列举节点

`POST /api/list-nodes`

列举集群中的所有节点，支持过滤。

支持的过滤条件：
- 状态：online（在线）/ offline（离线）/ maintenance（维护模式）
- 类型：compute / storage / hybrid
- 名称：模糊匹配

---

### 查询节点详情

`POST /api/describe-node`

查询节点的基本信息和状态。

返回信息包括：
- 基本信息：名称、UUID、URI
- 状态信息：在线状态、虚拟化类型（KVM/QEMU）
- 资源统计：虚拟机数量、存储池数量
- 连接信息：连接状态、最后心跳时间

---

### 查询节点概要信息

`POST /api/describe-node-summary`

查询节点的 CPU、内存、NUMA 等概要信息。

返回信息包括：

CPU 信息：
- 物理核心数
- 逻辑线程数（超线程）
- CPU 型号和厂商
- 主频（MHz）
- 架构（x86_64 / aarch64）
- CPU 缓存大小

内存信息：
- 总内存（GB）
- 可用内存（GB）
- 已用内存（GB）
- 内存使用率（%）
- Swap 大小和使用情况

NUMA 信息：
- NUMA 节点数量
- 每个 NUMA 节点的 CPU 列表
- 每个 NUMA 节点的内存大小
- NUMA 节点间的距离（延迟）

HugePages 配置：
- 是否启用大页内存
- 大页内存大小（2MB / 1GB）
- 大页数量（总数 / 已用 / 空闲）

虚拟化特性：
- VT-x / AMD-V：硬件虚拟化支持
- EPT / NPT：扩展页表支持
- IOMMU：I/O 内存管理单元支持（VT-d / AMD-Vi）
- Nested Virtualization：嵌套虚拟化支持

---

### 查询节点 PCI 设备

`POST /api/describe-node-pci`

查询节点的 PCI 设备列表，包括 GPU、网卡、NVMe 等。

返回信息包括：

GPU（显卡）：
- 设备型号（NVIDIA GeForce / AMD Radeon / Intel UHD）
- PCI 地址（如 0000:01:00.0）
- 驱动程序
- 是否支持 GPU 直通（Passthrough）
- IOMMU 组信息

网卡（Network Controllers）：
- 网卡型号（Intel I350 / Mellanox ConnectX）
- PCI 地址
- 速率（1G / 10G / 25G）
- 是否支持 SR-IOV
- VF 数量（如果支持 SR-IOV）

NVMe 控制器：
- NVMe 设备型号
- PCI 地址
- 连接的 NVMe 磁盘
- 是否支持 NVMe 直通

其他 PCI 设备：
- 其他可用于直通的设备
- IOMMU 隔离状态
- 设备当前使用状态

---

### 查询节点 USB 设备

`POST /api/describe-node-usb`

查询节点的 USB 设备列表。

返回信息包括：
- USB 设备列表（存储、输入设备等）
- USB 总线信息
- USB 控制器信息
- 设备厂商和产品 ID
- 是否可用于 USB 直通

---

### 查询节点网络接口

`POST /api/describe-node-net`

查询节点的网络接口详细信息。

返回信息包括：

物理网卡（NICs）：
- 接口名称（eth0、enp1s0 等）
- MAC 地址
- 速率（1G / 10G / 25G）
- 双工模式（全双工 / 半双工）
- 状态（up / down）
- IP 地址（如果配置）

网桥（Bridges）：
- 虚拟网桥名称（virbr0、br0 等）
- 绑定的物理接口
- 连接的虚拟机接口
- STP 状态（生成树协议）

绑定接口（Bonds）：
- 绑定名称（bond0 等）
- 绑定模式（balance-rr、active-backup、802.3ad 等）
- 成员接口列表
- 当前活动接口

SR-IOV 配置：
- 物理功能（PF）列表
- 每个 PF 的虚拟功能（VF）数量
- VF 已分配情况
- VF 最大数量

流量统计：
- 接收字节数（RX bytes）
- 发送字节数（TX bytes）
- 接收包数（RX packets）
- 发送包数（TX packets）
- 错误统计（errors、dropped）

---

### 查询节点物理磁盘

`POST /api/describe-node-disks`

查询节点的物理磁盘详细信息。

返回信息包括：

磁盘类型和接口：
- NVMe：nvme0n1、nvme1n1 等
- SATA：sda、sdb 等
- SAS：sdc、sdd 等
- 接口类型和速率

磁盘基本信息：
- 容量（GB / TB）
- 型号和序列号
- 固件版本
- 转速（HDD）或类型（SSD）

SMART 健康信息：
- 健康状态（Healthy / Warning / Failed）
- 温度（°C）
- 通电时间
- 读写次数
- 剩余寿命（SSD Wear Level）
- 错误日志统计

使用情况：
- 是否被 Storage Pool 使用
- 分区信息
- 文件系统类型
- 挂载点

---

### 启用节点

`POST /api/enable-node`

启用节点，恢复虚拟机调度。节点恢复正常工作状态。

关键行为：
- 节点退出维护模式
- 允许在该节点创建新虚拟机
- 允许虚拟机迁移到该节点

使用场景：
- 维护完成后恢复节点
- 扩容后激活新节点

---

### 禁用节点

`POST /api/disable-node`

禁用节点，进入维护模式。停止调度新虚拟机到该节点。

关键行为：
- 节点进入维护模式
- 停止创建新虚拟机
- 停止迁移虚拟机到该节点
- 现有虚拟机继续运行

使用场景：
- 节点维护前
- 节点资源不足时临时禁用
- 节点故障时隔离

注意事项：
- 不会影响已运行的虚拟机
- 建议先迁移虚拟机再维护

---

### 重启节点

`POST /api/reboot-node`

重启物理节点。需要严格的权限控制。

关键行为：
- 检查节点上的虚拟机状态
- 可选：自动迁移虚拟机到其他节点
- 可选：停止所有虚拟机
- 执行节点重启

注意事项：
- 操作风险高，需要二次确认
- 建议先迁移或停止虚拟机
- 重启期间虚拟机不可用
- 需要管理员权限

---

### 关闭节点

`POST /api/shutdown-node`

关闭物理节点。需要严格的权限控制。

关键行为：
- 检查节点上的虚拟机状态
- 停止所有虚拟机
- 执行节点关机

注意事项：
- 操作风险高，需要二次确认
- 必须先停止所有虚拟机
- 需要管理员权限
- 关机后需要物理访问才能重新启动

---

### 查询节点系统日志

`POST /api/describe-node-logs`

查询节点的系统日志，用于故障排查。

关键行为：
- 查询 journalctl 日志
- 支持按服务过滤（libvirtd、qemu 等）
- 支持按时间范围过滤
- 支持按日志级别过滤

过滤参数：
- 服务：libvirtd / qemu / kernel 等
- 时间范围：最近 N 小时/天
- 日志级别：error / warning / info
- 关键字：搜索特定内容

使用场景：
- 排查虚拟机启动失败
- 调查节点异常
- 监控系统错误
