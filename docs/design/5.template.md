# Template 模块

## 模块职责

模板（Template）是只读的虚拟机镜像，用于快速创建虚拟机。Template 模块负责模板的注册、管理和使用。

## 核心能力

### 模板注册

支持多种来源注册模板：
- 从 URL 下载官方云镜像
- 从本地文件导入镜像
- 从虚拟机快照导出

### 模板管理

管理模板的生命周期：列举、查询、删除、更新。

### 模板使用

基于模板快速创建虚拟机和存储卷。

## 核心说明

### 模板的本质

Template 是存储在 Storage Pool 中的特殊 Volume：

- 只读：不可修改，确保一致性和安全性
- 共享：可被多个虚拟机使用（作为 backing file）
- 标识：通过路径前缀 `_templates_/` 或元数据标记
- 存储位置：默认在 storage pool 的 `/var/lib/jvp/images/_templates_/` 目录

### 模板类型

模板根据来源分为两种类型：

1. Cloud Image Template（云镜像模板）
   - 来源：官方云镜像（Ubuntu Cloud Image、Debian Cloud、Alpine Linux 等）
   - 特点：
     - 预装 cloud-init，支持自动配置
     - 体积小，启动快
     - 定期更新，安全性好
     - 支持 SSH 密钥注入、网络配置等
   - 适用场景：快速创建标准化的 Linux 虚拟机

2. Snapshot Template（快照模板）
   - 来源：用户创建的虚拟机快照
   - 特点：
     - 包含自定义配置和软件
     - 完全自定义的环境
     - 可复用，节省配置时间
   - 适用场景：创建特定应用环境，如预装数据库、开发工具等

## API 端点

### 注册模板

`POST /api/register-template`

注册一个新的模板。支持多种来源。

注册方式：

1. 从 URL 下载
   - 下载官方云镜像并注册
   - 支持 HTTP/HTTPS/FTP
   - 常见来源：
     - Ubuntu: https://cloud-images.ubuntu.com/
     - Debian: https://cloud.debian.org/images/cloud/
     - Alpine: https://alpinelinux.org/cloud/

2. 从本地文件导入
   - 导入本地已有的镜像文件
   - 支持 qcow2、raw 等格式

3. 从快照导出
   - 将虚拟机快照导出为模板
   - 用于创建自定义模板

关键行为：
- 验证模板名称唯一性
- 下载或复制镜像文件到 _templates_ 目录
- 设置文件为只读
- 记录模板元数据（操作系统、版本、大小等）

注意事项：
- 从 URL 下载可能较慢，取决于网络速度
- 确保有足够的存储空间
- 模板名称应该清晰描述内容（如 ubuntu-22.04-server）

---

### 列举模板

`POST /api/list-templates`

列举所有模板，支持按类型、操作系统等条件过滤。

支持的过滤条件：
- 类型：cloud / snapshot
- 操作系统：ubuntu / debian / alpine / centos 等
- 名称：模糊匹配

---

### 查询模板详情

`POST /api/describe-template`

查询模板的详细信息。

返回信息包括：
- 基本信息：名称、UUID、路径
- 类型：cloud / snapshot
- 操作系统信息：操作系统、版本、架构
- 大小：模板文件大小
- 格式：qcow2 / raw
- 创建时间
- 使用统计：基于该模板创建的虚拟机数量

---

### 删除模板

`POST /api/delete-template`

删除一个模板。删除操作会移除模板文件。

关键行为：
- 验证模板是否存在
- 检查是否有虚拟机正在使用该模板（backing file）
- 删除模板文件

注意事项：
- 有虚拟机使用该模板作为 backing file 时无法删除
- 删除操作不可逆
- 建议删除前确认模板不再需要

---

### 更新模板

`POST /api/update-template`

更新官方云镜像模板到最新版本。仅支持 cloud image 类型的模板。

关键行为：
- 从官方源下载最新版本
- 替换旧的模板文件
- 保留模板名称和配置

注意事项：
- 更新期间模板不可用
- 更新前会备份旧版本
- 更新失败会自动回滚
- 仅支持 cloud image 模板

使用场景：
- 获取安全更新
- 使用最新版本的操作系统
- 定期维护模板库
