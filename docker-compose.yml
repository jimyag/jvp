# docker-compose.yml - JVP with libvirtd
# 在容器内运行完整的虚拟化环境
#
# 使用前请先停止宿主机的 libvirtd：
#   sudo systemctl stop libvirtd
#   sudo systemctl stop libvirtd.socket
#   sudo systemctl stop virtlogd
#   sudo systemctl stop virtlogd.socket

services:
  jvp:
    # 生产环境使用: ghcr.io/jimyag/jvp:latest
    # 本地调试使用: jvp:local (通过 task debug-image 构建)
    image: ghcr.io/jimyag/jvp:latest
    container_name: jvp
    hostname: jvp

    # 特权模式（接管宿主机 libvirt 需要）
    privileged: true

    # 设备挂载
    devices:
      - /dev/kvm:/dev/kvm # KVM 加速（必需）
      - /dev/net/tun:/dev/net/tun # TAP 网络
      - /dev/vhost-net:/dev/vhost-net # 高性能网络

    # 存储卷 - 挂载宿主机目录
    volumes:
      # 接管宿主机 libvirt（需先停止宿主机 libvirtd）
      - /var/lib/libvirt:/var/lib/libvirt
      - /var/run/libvirt:/var/run/libvirt
      - /etc/libvirt:/etc/libvirt
      # JVP 数据持久化
      - /var/lib/jvp:/var/lib/jvp

    # 环境变量
    environment:
      - TZ=Asia/Shanghai
      - JVP_ADDRESS=0.0.0.0:7777
      - JVP_DATA_DIR=/var/lib/jvp
      - LIBVIRT_URI=qemu:///system

    # 使用宿主机网络（VM 网络桥接需要）
    network_mode: host

    # cgroup 支持
    cgroup: host

    # 重启策略
    restart: unless-stopped

    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7777/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

